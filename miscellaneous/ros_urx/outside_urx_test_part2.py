#!/usr/bin/env python
import rospy
from std_msgs.msg import Bool
from geometry_msgs.msg import PoseStamped, TransformStamped, TwistStamped, Twist, Vector3, PointStamped
import urx
import time
import numpy as np
from datetime import datetime, timedelta
from gripperIO import GripperIO

def totimestamp(dt, epoch=datetime(1970,1,1)):
    td = dt - epoch
    return (td.microseconds + (td.seconds + td.days * 86400) * 10**6) / 10**6 

robotiq = GripperIO(15)
rob = urx.Robot("192.168.1.9")
rob.set_tcp((0, 0, 0, 0, 0, 0))
time.sleep(0.2)  
robotiq.set_speed(50)
robotiq.go_to(0)

pi = rob.get_pose()

delta = 0.05

pose1 = pi.copy()
pose1.pos =  [-0.6504899006445544, -0.4370090157150066, 0.07052690040939197]
pose1.orient[0][0] = 0.03569407288042137
pose1.orient[0][1] = -0.07355137706540515
pose1.orient[0][2] = -0.9966524610379436
pose1.orient[1][0] = 0.12591556870677695
pose1.orient[1][1] = -0.989009355737255
pose1.orient[1][2] = 0.0774968633005795
pose1.orient[2][0] = -0.9913986093990933
pose1.orient[2][1] = -0.12826024012125647
pose1.orient[2][2] = -0.026040508550747132
pose2 = pi.copy()
pose2.pos =  [-0.666471745196522, -0.40622076743472624, 0.07107551437517338]
pose2.orient[0][0] = 0.03351487815053944
pose2.orient[0][1] = -0.07122450548448822
pose2.orient[0][2] = -0.9968970973781822
pose2.orient[1][0] = 0.10514925206892939
pose2.orient[1][1] = -0.9916704797567439
pose2.orient[1][2] = 0.07438611677170759
pose2.orient[2][0] = -0.9938915372071037
pose2.orient[2][1] = -0.10731602581869809
pose2.orient[2][2] = -0.025746511813860895
pose3 = pi.copy()
pose3.pos =  [-0.6754076237468842, -0.3726429558868717, 0.07178798549439344]
pose3.orient[0][0] = 0.031183659056963742
pose3.orient[0][1] = -0.06936199687670531
pose3.orient[0][2] = -0.9971040531444525
pose3.orient[1][0] = 0.08333748948566609
pose3.orient[1][1] = -0.9939351616175724
pose3.orient[1][2] = 0.07174787346309763
pose3.orient[2][0] = -0.9960333539867255
pose3.orient[2][1] = -0.08533350976917625
pose3.orient[2][2] = -0.02521408051919305
pose4 = pi.copy()
pose4.pos =  [-0.6874938258453799, -0.33452200574400576, 0.07254434223795343]
pose4.orient[0][0] = 0.028643433566296284
pose4.orient[0][1] = -0.06769635745643593
pose4.orient[0][2] = -0.9972947191781694
pose4.orient[1][0] = 0.06040286788837553
pose4.orient[1][1] = -0.9957636384578298
pose4.orient[1][2] = 0.06932726646914586
pose4.orient[2][0] = -0.9977630215960063
pose4.orient[2][1] = -0.062225232119735435
pose4.orient[2][2] = -0.02443303548993503
pose5 = pi.copy()
pose5.pos =  [-0.6930761310994874, -0.31218658885886125, 0.0728632061353295]
pose5.orient[0][0] = 0.027557630304058223
pose5.orient[0][1] = -0.06656902832396026
pose5.orient[0][2] = -0.9974011938432943
pose5.orient[1][0] = 0.04742106527702093
pose5.orient[1][1] = -0.9965697072954737
pose5.orient[1][2] = 0.06782375003644753
pose5.orient[2][0] = -0.9984947769417811
pose5.orient[2][1] = -0.049166888949960755
pose5.orient[2][2] = -0.02430632532829391
pose6 = pi.copy()
pose6.pos =  [-0.7002521604039188, -0.27981986033682255, 0.07347644609422797]
pose6.orient[0][0] = 0.02581319328877596
pose6.orient[0][1] = -0.06532325856518419
pose6.orient[0][2] = -0.9975302255784848
pose6.orient[1][0] = 0.029268389056100453
pose6.orient[1][1] = -0.9973855635395494
pose6.orient[1][2] = 0.06607116651729623
pose6.orient[2][0] = -0.9992382300804437
pose6.orient[2][1] = -0.03090161052957659
pose6.orient[2][2] = -0.02383379978898259
pose7 = pi.copy()
pose7.pos =  [-0.7070191406236764, -0.246746129329852, 0.07401318675491116]
pose7.orient[0][0] = 0.0242863506600961
pose7.orient[0][1] = -0.06444494276458702
pose7.orient[0][2] = -0.9976256925940129
pose7.orient[1][0] = 0.012066270902592328
pose7.orient[1][1] = -0.9978284479980337
pose7.orient[1][2] = 0.06475178354563332
pose7.orient[2][0] = -0.9996322215085506
pose7.orient[2][1] = -0.013610206387281554
pose7.orient[2][2] = -0.023456001449000174
pose8 = pi.copy()
pose8.pos =  [-0.71184793069122, -0.21958043947053515, 0.07452398791431727]
pose8.orient[0][0] = 0.0233657184808147
pose8.orient[0][1] = -0.06367223417399219
pose8.orient[0][2] = -0.9976972936693613
pose8.orient[1][0] = -0.0016510752021555893
pose8.orient[1][1] = -0.997970851772969
pose8.orient[1][2] = 0.06365102483237586
pose8.orient[2][0] = -0.99972562093334
pose8.orient[2][1] = 0.00016002133358659215
pose8.orient[2][2] = -0.023423433621496348
pose9 = pi.copy()
pose9.pos =  [-0.7165227853706582, -0.18884266217492998, 0.07502724601176924]
pose9.orient[0][0] = 0.02220951896322776
pose9.orient[0][1] = -0.063045545181548
pose9.orient[0][2] = -0.9977634972778787
pose9.orient[1][0] = -0.01641612642559387
pose9.orient[1][1] = -0.9978981136626937
pose9.orient[1][2] = 0.06268863965358222
pose9.orient[2][0] = -0.9996185512787371
pose9.orient[2][1] = 0.014987127182991177
pose9.orient[2][2] = -0.023197800719031103
pose10 = pi.copy()
pose10.pos =  [-0.7211894388696233, -0.15555826592910282, 0.07557037960429272]
pose10.orient[0][0] = 0.021214232349388573
pose10.orient[0][1] = -0.06286930944127554
pose10.orient[0][2] = -0.997796274936023
pose10.orient[1][0] = -0.031097463016390176
pose10.orient[1][1] = -0.9975794675521757
pose10.orient[1][2] = 0.06219448297286281
pose10.orient[2][0] = -0.9992912008717831
pose10.orient[2][1] = 0.029709524545078456
pose10.orient[2][2] = -0.02311795863684718
pose11 = pi.copy()
pose11.pos =  [-0.7243580170777393, -0.12907146131295025, 0.07610338391563685]
pose11.orient[0][0] = 0.020169033278988335
pose11.orient[0][1] = -0.06267428480771688
pose11.orient[0][2] = -0.9978302180834333
pose11.orient[1][0] = -0.042153942597325064
pose11.orient[1][1] = -0.9971990558210747
pose11.orient[1][2] = 0.06178258810586115
pose11.orient[2][0] = -0.9989075308656414
pose11.orient[2][1] = 0.04081638265939626
pose11.orient[2][2] = -0.02275450914674393
pose12 = pi.copy()
pose12.pos =  [-0.727264415232494, -0.09903931404980981, 0.07660549889236098]
pose12.orient[0][0] = 0.019420430155344337
pose12.orient[0][1] = -0.06240193208120068
pose12.orient[0][2] = -0.9978621376548538
pose12.orient[1][0] = -0.05415468673748622
pose12.orient[1][1] = -0.9966508838823644
pose12.orient[1][2] = 0.061272225036033884
pose12.orient[2][0] = -0.9983436867116182
pose12.orient[2][1] = 0.05284897850512213
pose12.orient[2][2] = -0.022734745963371217
pose13 = pi.copy()
pose13.pos =  [-0.7300229427193444, -0.06321078108147887, 0.07731342163983893]
pose13.orient[0][0] = 0.018816125639554704
pose13.orient[0][1] = -0.06269960319826769
pose13.orient[0][2] = -0.9978550561953857
pose13.orient[1][0] = -0.0671244868323601
pose13.orient[1][1] = -0.9958592150698539
pose13.orient[1][2] = 0.06130845804574551
pose13.orient[2][0] = -0.9975671690083875
pose13.orient[2][1] = 0.06582692093083499
pose13.orient[2][2] = -0.022946890799339092
pose14 = pi.copy()
pose14.pos =  [-0.7312088855472482, -0.04478428665600988, 0.07787210446497003]
pose14.orient[0][0] = 0.01817019317102775
pose14.orient[0][1] = -0.06312127996948473
pose14.orient[0][2] = -0.9978404422026306
pose14.orient[1][0] = -0.07752659205186165
pose14.orient[1][1] = -0.9950894459022424
pose14.orient[1][2] = 0.06153553590237438
pose14.orient[2][0] = -0.9968246945200303
pose14.orient[2][1] = 0.07624105632126373
pose14.orient[2][2] = -0.02297454517648012
pose15 = pi.copy()
pose15.pos =  [-0.7333379805541761, -0.009052797473575703, 0.07850387619468749]
pose15.orient[0][0] = 0.01762521452264343
pose15.orient[0][1] = -0.06346852134996481
pose15.orient[0][2] = -0.9978281909280174
pose15.orient[1][0] = -0.08454960666919406
pose15.orient[1][1] = -0.9945032046186438
pose15.orient[1][2] = 0.06176358162649172
pose15.orient[2][0] = -0.9962633767358487
pose15.orient[2][1] = 0.08327738469054365
pose15.orient[2][2] = -0.02289457084087454
pose16 = pi.copy()
pose16.pos =  [-0.7344407331034786, 0.023329047399889502, 0.07906491991034395]
pose16.orient[0][0] = 0.01758378668039262
pose16.orient[0][1] = -0.064127416949929
pose16.orient[0][2] = -0.9977867932786587
pose16.orient[1][0] = -0.09341673449077197
pose16.orient[1][1] = -0.9936811977476155
pose16.orient[1][2] = 0.06221728827218926
pose16.orient[2][0] = -0.9954718098284147
pose16.orient[2][1] = 0.09211596842130057
pose16.orient[2][2] = -0.023463252092301268
pose17 = pi.copy()
pose17.pos =  [-0.7352173559936028, 0.05746666413906046, 0.07977931382500841]
pose17.orient[0][0] = 0.01727021198344969
pose17.orient[0][1] = -0.0650559596156281
pose17.orient[0][2] = -0.9977321593977697
pose17.orient[1][0] = -0.10144994408563138
pose17.orient[1][1] = -0.9928450383726656
pose17.orient[1][2] = 0.06298125613071356
pose17.orient[2][0] = -0.9946907301383023
pose17.orient[2][1] = 0.1001321721389786
pose17.orient[2][2] = -0.02374656774485495
pose18 = pi.copy()
pose18.pos =  [-0.7354059864376935, 0.07943929378145352, 0.08015950234049529]
pose18.orient[0][0] = 0.017178583973748385
pose18.orient[0][1] = -0.06582372852092147
pose18.orient[0][2] = -0.9976833831513185
pose18.orient[1][0] = -0.10618584123272526
pose18.orient[1][1] = -0.9923076281337703
pose18.orient[1][2] = 0.0636406966431827
pose18.orient[2][0] = -0.9941978995020837
pose18.orient[2][1] = 0.10484659227240137
pose18.orient[2][2] = -0.02403598790375583
pose19 = pi.copy()
pose19.pos =  [-0.7350846922562686, 0.11178728671304533, 0.0810206182238096]
pose19.orient[0][0] = 0.017232157612189214
pose19.orient[0][1] = -0.0669145166937409
pose19.orient[0][2] = -0.9976098937960028
pose19.orient[1][0] = -0.1122449476507961
pose19.orient[1][1] = -0.991580368857586
pose19.orient[1][2] = 0.06457123061490873
pose19.orient[2][0] = -0.9935311391551344
pose19.orient[2][1] = 0.11086396868187946
pose19.orient[2][2] = -0.024597885624673577
pose20 = pi.copy()
pose20.pos =  [-0.7343235926284096, 0.14642041689395746, 0.08176997961583647]
pose20.orient[0][0] = 0.017474834599204847
pose20.orient[0][1] = -0.06824351445104497
pose20.orient[0][2] = -0.9975156404242995
pose20.orient[1][0] = -0.11723363268580049
pose20.orient[1][1] = -0.9909261646852161
pose20.orient[1][2] = 0.06573896492597629
pose20.orient[2][0] = -0.9929506057820909
pose20.orient[2][1] = 0.115793604649039
pose20.orient[2][2] = -0.025316705934240513
pose21 = pi.copy()
pose21.pos =  [-0.7333461810525937, 0.17684741427881248, 0.08252713072920921]
pose21.orient[0][0] = 0.017896984689908746
pose21.orient[0][1] = -0.06968649026438517
pose21.orient[0][2] = -0.9974083872785717
pose21.orient[1][0] = -0.1205604205711277
pose21.orient[1][1] = -0.990439959274108
pose21.orient[1][2] = 0.06703634883267567
pose21.orient[2][0] = -0.9925446503461304
pose21.orient[2][1] = 0.11904822614274904
pose21.orient[2][2] = -0.02612732136180207
pose22 = pi.copy()
pose22.pos =  [-0.7325357775428444, 0.20655125399924928, 0.08330477767063564]
pose22.orient[0][0] = 0.018339707323156262
pose22.orient[0][1] = -0.07126757576734415
pose22.orient[0][2] = -0.9972886180938528
pose22.orient[1][0] = -0.12294432244085586
pose22.orient[1][1] = -0.9900474335076203
pose22.orient[1][2] = 0.06848921801665644
pose22.orient[2][0] = -0.9922440973444285
pose22.orient[2][1] = 0.12135490121630893
pose22.orient[2][2] = -0.02691912398129015
pose23 = pi.copy()
pose23.pos =  [-0.7301981996640153, 0.23525952074807852, 0.08387093054254426]
pose23.orient[0][0] = 0.019100984271330446
pose23.orient[0][1] = -0.07275392743684325
pose23.orient[0][2] = -0.9971669962661124
pose23.orient[1][0] = -0.1238380094626049
pose23.orient[1][1] = -0.9898411512687255
pose23.orient[1][2] = 0.06984728103042931
pose23.orient[2][0] = -0.9921185916069742
pose23.orient[2][1] = 0.12215302410304271
pose23.orient[2][2] = -0.02791664181586484
pose24 = pi.copy()
pose24.pos =  [-0.7281466759287164, 0.2633923662373045, 0.08463328892722552]
pose24.orient[0][0] = 0.01958025813099351
pose24.orient[0][1] = -0.07421056892995695
pose24.orient[0][2] = -0.9970503522644258
pose24.orient[1][0] = -0.12382772813792023
pose24.orient[1][1] = -0.9897435388776896
pose24.orient[1][2] = 0.07123497030299528
pose24.orient[2][0] = -0.9921105317633339
pose24.orient[2][1] = 0.12206768085353062
pose24.orient[2][2] = -0.028568760129127235
pose25 = pi.copy()
pose25.pos =  [-0.7258391873003849, 0.29484913828307036, 0.08539877479145551]
pose25.orient[0][0] = 0.02043017274397929
pose25.orient[0][1] = -0.0757945944936746
pose25.orient[0][2] = -0.9969141324543407
pose25.orient[1][0] = -0.12284216562168304
pose25.orient[1][1] = -0.9897573997484065
pose25.orient[1][2] = 0.07273301855861665
pose25.orient[2][0] = -0.992215909158398
pose25.orient[2][1] = 0.12097714283620899
pose25.orient[2][2] = -0.029531686781511635
pose26 = pi.copy()
pose26.pos =  [-0.7239235201675379, 0.3202113738184432, 0.08575503050633908]
pose26.orient[0][0] = 0.021809370882836188
pose26.orient[0][1] = -0.07749276557672352
pose26.orient[0][2] = -0.996754344171605
pose26.orient[1][0] = -0.12032537023565903
pose26.orient[1][1] = -0.9899478437318675
pose26.orient[1][2] = 0.07433082784604042
pose26.orient[2][0] = -0.9924949151604491
pose26.orient[2][1] = 0.11831372690392733
pose26.orient[2][2] = -0.030914485387216306
pose27 = pi.copy()
pose27.pos =  [-0.7220168007862914, 0.339808088980813, 0.08618454095380167]
pose27.orient[0][0] = 0.022525012196837002
pose27.orient[0][1] = -0.07866360615063084
pose27.orient[0][2] = -0.9966467081633849
pose27.orient[1][0] = -0.11778067779222959
pose27.orient[1][1] = -0.990166120714042
pose27.orient[1][2] = 0.07549016710080958
pose27.orient[2][0] = -0.9927841335176221
pose27.orient[2][1] = 0.11568530787219089
pose27.orient[2][2] = -0.031568556795980474
pose28 = pi.copy()
pose28.pos =  [-0.7194333458196938, 0.36029944034910033, 0.08661642840016515]
pose28.orient[0][0] = 0.023356283842612013
pose28.orient[0][1] = -0.0796478157057958
pose28.orient[0][2] = -0.9965494014138784
pose28.orient[1][0] = -0.11479316903357639
pose28.orient[1][1] = -0.9904418116122767
pose28.orient[1][2] = 0.07646924972444899
pose28.orient[2][0] = -0.9931148032067051
pose28.orient[2][1] = 0.11261102638501691
pose28.orient[2][2] = -0.032276065253077246
pose29 = pi.copy()
pose29.pos =  [-0.7193827713069225, 0.3604250330489396, 0.08648490557065683]
pose29.orient[0][0] = 0.023618064949292306
pose29.orient[0][1] = -0.07990533623332861
pose29.orient[0][2] = -0.9965226160250903
pose29.orient[1][0] = -0.11505127757821461
pose29.orient[1][1] = -0.9903950083208937
pose29.orient[1][2] = 0.07668722853694457
pose29.orient[2][0] = -0.9930787433711746
pose29.orient[2][1] = 0.11283999616490448
pose29.orient[2][2] = -0.03258442465093925


poseup = pi.copy()
poseup.pos =  [-0.7193827713069225, 0.3604250330489396, 0.12]
poseup.orient[0][0] = 0.023618064949292306
poseup.orient[0][1] = -0.07990533623332861
poseup.orient[0][2] = -0.9965226160250903
poseup.orient[1][0] = -0.11505127757821461
poseup.orient[1][1] = -0.9903950083208937
poseup.orient[1][2] = 0.07668722853694457
poseup.orient[2][0] = -0.9930787433711746
poseup.orient[2][1] = 0.11283999616490448
poseup.orient[2][2] = -0.03258442465093925

new_x = pose1.pos[0] + 0.05
pose1.pos[0] = new_x
pose2.pos[0] = new_x
pose3.pos[0] = new_x
pose4.pos[0] = new_x
pose5.pos[0] = -0.63
pose6.pos[0] = -0.66
pose7.pos[0] = -0.69

dz = 0.05

pose1.pos[2]-= dz 
pose2.pos[2]-= dz 
pose3.pos[2]-= dz 
pose4.pos[2]-= dz 
pose5.pos[2]-= dz 
pose6.pos[2]-= dz 
pose7.pos[2]-= dz 
pose8.pos[2]-= dz 
pose9.pos[2]-= dz 
pose10.pos[2]-= dz 
pose11.pos[2]-= dz 
# pose12.pos[2]-= dz 
# pose13.pos[2]-= dz 
# pose14.pos[2]-= dz 
# pose15.pos[2]-= dz 
# pose16.pos[2]-= dz 
# pose17.pos[2]-= dz 
# pose18.pos[2]-= dz 
# pose19.pos[2]-= dz 
# pose20.pos[2]-= dz 
# pose21.pos[2]-= dz
# pose22.pos[2]-= dz 
# pose23.pos[2]-= dz 
# pose24.pos[2]-= dz 
# pose25.pos[2]-= dz 
# pose26.pos[2]-= dz 
# pose27.pos[2]-= dz 
# pose28.pos[2]-= dz 
# pose29.pos[2]-= dz

poses = [pose1,pose2,pose3,pose4,pose5,pose6,pose7,pose8,pose9,pose10,pose11,pose12]



def callback(data):

    global poses
    global rob
    global poseup
    global robotiq


    # j0 = [0.1997201144695282, -2.0373409430133265, 2.512094020843506, -2.2755797545062464, -1.5713632742511194, -0.1660998503314417]
    # rob.movej(j0, 0.75, 2, wait=False)
    # rospy.sleep(3.65)


    # j_part2_start = [ 0.5211220383644104, -0.6330521742450159, 1.2401795387268066, -0.5811103026019495, 1.96116304397583, -1.4885252157794397 ]
    # rob.movej(j_part2_start, 0.75, 2.0, wait=False)
    # time.sleep(4.8)


    rospy.loginfo('ur5 run starts ....')
    try:
        rob.movexs("movep", poses, acc=0.075, vel=0.15, radius=0.005, wait=False)  # joint
    except KeyboardInterrupt:
        print('Interrupted')

    tsec = totimestamp(datetime.utcnow())
    i = 0
    # j_target = [0.18971,-0.71059,1.2339,-0.50045,1.7517,-1.5081]
    j_target = [0.260927677154541, -0.6943581740008753, 1.3569297790527344, -0.6393244902240198, 1.8019181489944458, -1.5046008268939417]
    tolerance = 0.06

    while totimestamp(datetime.utcnow()) - tsec < 4.5:
        i+=1
        if i % 50000 == 0:
            js = rob.getj()
            print js
            if (abs(js[0] - j_target[0]) < tolerance) and (abs(js[1] - j_target[1]) < tolerance) and (abs(js[2] - j_target[2]) < tolerance) and (abs(js[3] - j_target[3]) < tolerance) and (abs(js[4] - j_target[4]) < tolerance) and (abs(js[5] - j_target[5]) < tolerance):
                robotiq.go_to(126)
    # rob.movel(poseup, acc=0.2, vel=0.5, wait=False)
    # rospy.sleep(2.5)
    j_end = [-1.6027973333941858, -1.4326069990741175, 2.1036601066589355, -3.7062509695636194, -1.5683444182025355, -0.1680229345904749]
    rob.movej(j_end, 0.2, 1, wait=False)
    time.sleep(10)
    robotiq.go_to(0)
    j_part2_start = [ 0.5211220383644104, -0.6330521742450159, 1.2401795387268066, -0.5811103026019495, 1.96116304397583, -1.4885252157794397 ]
    rob.movej(j_part2_start, 0.75, 2.0, wait=False)
    time.sleep(4.8)    



def print_poseyawjoint(data):

    global rob

    print 'pose:',data.point.x,data.point.y,'\tyaw:',data.point.z,'\trobot_joint_angles:',rob.getj()
    
def ur5_to_base():
    rospy.init_node('demo_straight_arm', anonymous=True)
    rospy.Subscriber("ur5_run", Bool, callback)
    # rospy.Subscriber('base_pose',PointStamped,print_poseyawjoint)
    rospy.spin()

if __name__ == '__main__':
    j_part2_start = [ 0.5211220383644104, -0.6330521742450159, 1.2401795387268066, -0.5811103026019495, 1.96116304397583, -1.4885252157794397 ]
    rob.movej(j_part2_start, 0.75, 2.0, wait=False)
    time.sleep(4.8)
    ur5_to_base()
