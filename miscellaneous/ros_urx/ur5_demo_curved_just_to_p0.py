#!/usr/bin/env python
import rospy
from std_msgs.msg import Bool
from geometry_msgs.msg import PoseStamped, TransformStamped, TwistStamped, Twist, Vector3, PointStamped
import urx
import time
import numpy as np
from datetime import datetime, timedelta
from gripperIO import GripperIO

def totimestamp(dt, epoch=datetime(1970,1,1)):
    td = dt - epoch
    return (td.microseconds + (td.seconds + td.days * 86400) * 10**6) / 10**6 

robotiq = GripperIO(15)
rob = urx.Robot("192.168.1.9")
rob.set_tcp((0, 0, 0, 0, 0, 0))
time.sleep(0.2)  
robotiq.set_speed(50)

pi = rob.get_pose()

pose1 = pi.copy()
pose1.pos =  [-0.5971164242966798, -0.03969036926253853, 0.12575295429478242]
pose1.orient[0][0] = -0.046336859843265965
pose1.orient[0][1] = 0.9989169920472446
pose1.orient[0][2] = -0.0042117002683915395
pose1.orient[1][0] = 0.9989258144527485
pose1.orient[1][1] = 0.0463350288044887
pose1.orient[1][2] = -0.0005313432041137102
pose1.orient[2][0] = -0.0003356185019462185
pose1.orient[2][1] = -0.004231796896411566
pose1.orient[2][2] = -0.9999909895870306
pose2 = pi.copy()
pose2.pos =  [-0.5975965739737288, 0.003315589005324555, 0.12591866959394998]
pose2.orient[0][0] = -0.04477197460515314
pose2.orient[0][1] = 0.9989891433901474
pose2.orient[0][2] = -0.004020159023672848
pose2.orient[1][0] = 0.9989969794257256
pose2.orient[1][1] = 0.04476873704756057
pose2.orient[1][2] = -0.0008917855366860766
pose2.orient[2][0] = -0.0007109066271615597
pose2.orient[2][1] = -0.004056053720862
pose2.orient[2][2] = -0.9999915214840479
pose3 = pi.copy()
pose3.pos =  [-0.5984794757782715, 0.02823223196821798, 0.12620976253242572]
pose3.orient[0][0] = -0.04395678949253701
pose3.orient[0][1] = 0.9990256295674961
pose3.orient[0][2] = -0.0039486864622143404
pose3.orient[1][0] = 0.9990327068984567
pose3.orient[1][1] = 0.043951648149425204
pose3.orient[1][2] = -0.0013795550338761863
pose3.orient[2][0] = -0.0012046595582015215
pose3.orient[2][1] = -0.004005507735256748
pose3.orient[2][2] = -0.9999912523133048
pose4 = pi.copy()
pose4.pos =  [-0.5987729268190813, 0.05457215878391865, 0.1264868028170621]
pose4.orient[0][0] = -0.04308120604145893
pose4.orient[0][1] = 0.9990638069674905
pose4.orient[0][2] = -0.003939453469509222
pose4.orient[1][0] = 0.9990709549286892
pose4.orient[1][1] = 0.04307645533333049
pose4.orient[1][2] = -0.0012829706905596418
pose4.orient[2][0] = -0.0011120718909211787
pose4.orient[2][1] = -0.003991065464344869
pose4.orient[2][2] = -0.9999914173094531
pose5 = pi.copy()
pose5.pos =  [-0.5997435688650434, 0.08681807302700102, 0.12712916999407897]
pose5.orient[0][0] = -0.0423915424907807
pose5.orient[0][1] = 0.999093663319184
pose5.orient[0][2] = -0.0038482516426823756
pose5.orient[1][0] = 0.999100306088899
pose5.orient[1][1] = 0.04238641827658651
pose5.orient[1][2] = -0.0014035379406366472
pose5.orient[2][0] = -0.0012391522589578347
pose5.orient[2][1] = -0.0039042875323589904
pose5.orient[2][2] = -0.9999916104850799
pose6 = pi.copy()
pose6.pos =  [-0.6007235556533282, 0.10768858532188484, 0.1275584657021612]
pose6.orient[0][0] = -0.04175923899042755
pose6.orient[0][1] = 0.9991202268123078
pose6.orient[0][2] = -0.003865014031415981
pose6.orient[1][0] = 0.9991267578428122
pose6.orient[1][1] = 0.041753567465810826
pose6.orient[1][2] = -0.0015366738068475294
pose6.orient[2][0] = -0.0013739437583170028
pose6.orient[2][1] = -0.003925809266976102
pose6.orient[2][2] = -0.9999913501126638
pose7 = pi.copy()
pose7.pos =  [-0.6020071163839563, 0.1443019309402089, 0.1285603072675302]
pose7.orient[0][0] = -0.0409654818027273
pose7.orient[0][1] = 0.9991533090676792
pose7.orient[0][2] = -0.00380713537684652
pose7.orient[1][0] = 0.9991592248454346
pose7.orient[1][1] = 0.04095889505823269
pose7.orient[1][2] = -0.001792295142887648
pose7.orient[2][0] = -0.0016348415644693813
pose7.orient[2][1] = -0.0038773566660726807
pose7.orient[2][2] = -0.9999911466599808
pose8 = pi.copy()
pose8.pos =  [-0.6032599860396769, 0.1660416792613777, 0.12931513815061735]
pose8.orient[0][0] = -0.040670976951166726
pose8.orient[0][1] = 0.9991657533881014
pose8.orient[0][2] = -0.0036971462272454942
pose8.orient[1][0] = 0.9991707873593106
pose8.orient[1][1] = 0.04066358945212667
pose8.orient[1][2] = -0.0020518724727771878
pose8.orient[2][0] = -0.0018998214687895362
pose8.orient[2][1] = -0.0037775321649064393
pose8.orient[2][2] = -0.999991060424607
pose9 = pi.copy()
pose9.pos =  [-0.604192774066593, 0.200932205544676, 0.1303711160623934]
pose9.orient[0][0] = -0.040166360729004036
pose9.orient[0][1] = 0.9991864844219993
pose9.orient[0][2] = -0.003610098917334122
pose9.orient[1][0] = 0.9991906845134366
pose9.orient[1][1] = 0.04015821674650677
pose9.orient[1][2] = -0.0023007844988541777
pose9.orient[2][0] = -0.0021539376400241048
pose9.orient[2][1] = -0.0036995913485129758
pose9.orient[2][2] = -0.9999908367462659
pose10 = pi.copy()
pose10.pos =  [-0.6057269774738294, 0.23320925250616237, 0.13130865275046527]
pose10.orient[0][0] = -0.039994053472655944
pose10.orient[0][1] = 0.9991931574139892
pose10.orient[0][2] = -0.0036755766743851977
pose10.orient[1][0] = 0.9991975864541072
pose10.orient[1][1] = 0.03998574330598659
pose10.orient[1][2] = -0.0023072833711397745
pose10.orient[2][0] = -0.0021584510912545053
pose10.orient[2][1] = -0.0037649049563946374
pose10.orient[2][2] = -0.9999905832454403
pose11 = pi.copy()
pose11.pos =  [-0.6060689160081401, 0.25950859180488045, 0.1322006585895113]
pose11.orient[0][0] = -0.039784640229279966
pose11.orient[0][1] = 0.9992017973720401
pose11.orient[0][2] = -0.00359868452511069
pose11.orient[1][0] = 0.99920519036161
pose11.orient[1][1] = 0.03977530618890479
pose11.orient[1][2] = -0.002629177057088819
pose11.orient[2][0] = -0.0024839396621889284
pose11.orient[2][1] = -0.003700425119279963
pose11.orient[2][2] = -0.9999900683995273
pose12 = pi.copy()
pose12.pos =  [-0.6070238119528705, 0.29677220494206397, 0.1332331227081641]
pose12.orient[0][0] = -0.03969149100834468
pose12.orient[0][1] = 0.999205230620895
pose12.orient[0][2] = -0.003673233096147514
pose12.orient[1][0] = 0.999208681452519
pose12.orient[1][1] = 0.0396816426403408
pose12.orient[1][2] = -0.002716274522703527
pose12.orient[2][0] = -0.0025683557878316415
pose12.orient[2][1] = -0.0037781393844633945
pose12.orient[2][2] = -0.99998956455122
pose13 = pi.copy()
pose13.pos =  [-0.6071210067656269, 0.3258212805444523, 0.13410056265343265]
pose13.orient[0][0] = -0.03994303317356074
pose13.orient[0][1] = 0.9991945538718016
pose13.orient[0][2] = -0.003846766671828517
pose13.orient[1][0] = 0.9991975822585658
pose13.orient[1][1] = 0.03993116794800988
pose13.orient[1][2] = -0.003113428165968269
pose13.orient[2][0] = -0.0029573145812769753
pose13.orient[2][1] = -0.003968039722520652
pose13.orient[2][2] = -0.9999877544006366
pose14 = pi.copy()
pose14.pos =  [-0.6072777272056368, 0.3606207311774722, 0.13495114859432003]
pose14.orient[0][0] = -0.040326176874211694
pose14.orient[0][1] = 0.9991792119380632
pose14.orient[0][2] = -0.0038343043099053086
pose14.orient[1][0] = 0.9991818222518122
pose14.orient[1][1] = 0.040313860029013826
pose14.orient[1][2] = -0.0032370930028939276
pose14.orient[2][0] = -0.003079860428343606
pose14.orient[2][1] = -0.003961706752432137
pose14.orient[2][2] = -0.9999874095904157
pose15 = pi.copy()
pose15.pos =  [-0.6071508494137758, 0.3710857446778524, 0.13519222856607516]
pose15.orient[0][0] = -0.0401740338429466
pose15.orient[0][1] = 0.9991858643034591
pose15.orient[0][2] = -0.003695345847897378
pose15.orient[1][0] = 0.9991874419239976
pose15.orient[1][1] = 0.04016155248051767
pose15.orient[1][2] = -0.0033919911163268887
pose15.orient[2][0] = -0.0032408187490727447
pose15.orient[2][1] = -0.0038286131306873366
pose15.orient[2][2] = -0.999987419328529
pose16 = pi.copy()
pose16.pos =  [-0.6067807715904023, 0.40621340339029294, 0.13574866702873004]
pose16.orient[0][0] = -0.041180610762899694
pose16.orient[0][1] = 0.9991433613698608
pose16.orient[0][2] = -0.004086652386744696
pose16.orient[1][0] = 0.9991454100647421
pose16.orient[1][1] = 0.041165471521238284
pose16.orient[1][2] = -0.003722029149849308
pose16.orient[2][0] = -0.0035506117434533045
pose16.orient[2][1] = -0.004236435408414197
pose16.orient[2][2] = -0.9999847227689419
pose17 = pi.copy()
pose17.pos =  [-0.6061719905992335, 0.432778565081239, 0.1358558753808385]
pose17.orient[0][0] = -0.041558348823593994
pose17.orient[0][1] = 0.9991280212076821
pose17.orient[0][2] = -0.00401259027039949
pose17.orient[1][0] = 0.9991294823626444
pose17.orient[1][1] = 0.04154314607809095
pose17.orient[1][2] = -0.0038005904394585502
pose17.orient[2][0] = -0.003630580781442324
pose17.orient[2][1] = -0.004167043503016261
pose17.orient[2][2] = -0.9999847271991875
pose18 = pi.copy()
pose18.pos =  [-0.6052921169876654, 0.4681041531373339, 0.1358654543054902]
pose18.orient[0][0] = -0.04271552088576824
pose18.orient[0][1] = 0.9990782401517752
pose18.orient[0][2] = -0.004249038795921926
pose18.orient[1][0] = 0.9990795586245177
pose18.orient[1][1] = 0.04269808899069205
pose18.orient[1][2] = -0.004112023246746321
pose18.orient[2][0] = -0.0039268071121893264
pose18.orient[2][1] = -0.004420775019687287
pose18.orient[2][2] = -0.9999825183142598
pose19 = pi.copy()
pose19.pos =  [-0.6041868157028403, 0.4742565256582781, 0.13589818168480894]
pose19.orient[0][0] = -0.04286722185735814
pose19.orient[0][1] = 0.9990721623810331
pose19.orient[0][2] = -0.004149174076661763
pose19.orient[1][0] = 0.9990729375404644
pose19.orient[1][1] = 0.042850062581299975
pose19.orient[1][2] = -0.004139759781189815
pose19.orient[2][0] = -0.003958126387485677
pose19.orient[2][1] = -0.004322787534113645
pose19.orient[2][2] = -0.999982823224197
pose20 = pi.copy()
pose20.pos =  [-0.6041961072840015, 0.4742400027778021, 0.13589279929873693]
pose20.orient[0][0] = -0.04308299583495723
pose20.orient[0][1] = 0.9990628467966102
pose20.orient[0][2] = -0.004157357398410686
pose20.orient[1][0] = 0.9990636889255379
pose20.orient[1][1] = 0.043065834858030616
pose20.orient[1][2] = -0.004132715629829507
pose20.orient[2][0] = -0.003949802574972547
pose20.orient[2][1] = -0.0043315145889050635
pose20.orient[2][2] = -0.9999828183728883
pose21 = pi.copy()
pose21.pos =  [-0.6041662063579817, 0.4742879909655832, 0.13586147844205446]
pose21.orient[0][0] = -0.04298701434132235
pose21.orient[0][1] = 0.9990669839694533
pose21.orient[0][2] = -0.00415669823284603
pose21.orient[1][0] = 0.9990678196910168
pose21.orient[1][1] = 0.04296985380037188
pose21.orient[1][2] = -0.004133197577239397
pose21.orient[2][0] = -0.003950728522284757
pose21.orient[2][1] = -0.004330497264131296
pose21.orient[2][2] = -0.999982819121203
pose22 = pi.copy()
pose22.pos =  [-0.6041660493728345, 0.47426004331721755, 0.13583295727939673]
pose22.orient[0][0] = -0.04296326501232672
pose22.orient[0][1] = 0.999067591845928
pose22.orient[0][2] = -0.004254971522658722
pose22.orient[1][0] = 0.9990691306672477
pose22.orient[1][1] = 0.04294602549242521
pose22.orient[1][2] = -0.004063378175085646
pose22.orient[2][0] = -0.0038768553326604745
pose22.orient[2][1] = -0.004425586693538053
pose22.orient[2][2] = -0.9999826919377893
pose23 = pi.copy()
pose23.pos =  [-0.6041759818040543, 0.47425882687622134, 0.13585304857869615]
pose23.orient[0][0] = -0.04301079297731747
pose23.orient[0][1] = 0.9990658463760552
pose23.orient[0][2] = -0.00418405214581292
pose23.orient[1][0] = 0.9990668953569596
pose23.orient[1][1] = 0.042993628449468635
pose23.orient[1][2] = -0.004109320449301625
pose23.orient[2][0] = -0.003925594129341677
pose23.orient[2][1] = -0.004356893118451308
pose23.orient[2][2] = -0.9999828034486824
pose24 = pi.copy()
pose24.pos =  [-0.6041770386047454, 0.4742519699769283, 0.13588858272648038]
pose24.orient[0][0] = -0.042987113281176326
pose24.orient[0][1] = 0.9990670431479539
pose24.orient[0][2] = -0.004141423349065204
pose24.orient[1][0] = 0.9990678848664082
pose24.orient[1][1] = 0.0429700919272068
pose24.orient[1][2] = -0.0041149274998895065
pose24.orient[2][0] = -0.003933131108064
pose24.orient[2][1] = -0.004314451920268507
pose24.orient[2][2] = -0.9999829578469397
pose25 = pi.copy()
pose25.pos =  [-0.6041696573196187, 0.47426424611450724, 0.1358405498486576]
pose25.orient[0][0] = -0.04304705557123856
pose25.orient[0][1] = 0.9990641325737591
pose25.orient[0][2] = -0.004220190906653534
pose25.orient[1][0] = 0.9990654630311112
pose25.orient[1][1] = 0.0430298871987983
pose25.orient[1][2] = -0.004077914428960593
pose25.orient[2][0] = -0.0038925037030088355
pose25.orient[2][1] = -0.004391789191273721
pose25.orient[2][2] = -0.9999827801530492
pose26 = pi.copy()
pose26.pos =  [-0.6041725181949497, 0.4742588679585253, 0.1358541839014737]
pose26.orient[0][0] = -0.04307082314161004
pose26.orient[0][1] = 0.9990632661411615
pose26.orient[0][2] = -0.004182635683295197
pose26.orient[1][0] = 0.999064242856294
pose26.orient[1][1] = 0.04305358990704822
pose26.orient[1][2] = -0.004126383658332703
pose26.orient[2][0] = -0.003942440853606207
pose26.orient[2][1] = -0.004356448492837511
pose26.orient[2][2] = -0.9999827391093533
pose27 = pi.copy()
pose27.pos =  [-0.6041933586456149, 0.474260554414577, 0.13590106948422953]
pose27.orient[0][0] = -0.043023551738605614
pose27.orient[0][1] = 0.999065456254243
pose27.orient[0][2] = -0.004145855194952531
pose27.orient[1][0] = 0.999066082161694
pose27.orient[1][1] = 0.04300625614989595
pose27.orient[1][2] = -0.004174374929680511
pose27.orient[2][0] = -0.003992176083223028
pose27.orient[2][1] = -0.004321579742594379
pose27.orient[2][2] = -0.9999826930895599
pose28 = pi.copy()
pose28.pos =  [-0.604158465868559, 0.474282721196411, 0.13588524592995482]
pose28.orient[0][0] = -0.04297511307738067
pose28.orient[0][1] = 0.9990675950472973
pose28.orient[0][2] = -0.00413281773085941
pose28.orient[1][0] = 0.9990683701849669
pose28.orient[1][1] = 0.04295809353545654
pose28.orient[1][2] = -0.004122365310520675
pose28.orient[2][0] = -0.003940983626041044
pose28.orient[2][1] = -0.004306126590007142
pose28.orient[2][2] = -0.9999829628157922
pose29 = pi.copy()
pose29.pos =  [-0.6041623268330517, 0.47428928753860594, 0.13586486017069596]
pose29.orient[0][0] = -0.04302322939208947
pose29.orient[0][1] = 0.9990653757520718
pose29.orient[0][2] = -0.004168537638954836
pose29.orient[1][0] = 0.9990664280303729
pose29.orient[1][1] = 0.043006203980402335
pose29.orient[1][2] = -0.004091308082752846
pose29.orient[2][0] = -0.003908211267012085
pose29.orient[2][1] = -0.004340667295218757
pose29.orient[2][2] = -0.9999829421005764
pose30 = pi.copy()
pose30.pos =  [-0.6041583869227467, 0.474270972035597, 0.13586175260594371]
pose30.orient[0][0] = -0.04304702098360624
pose30.orient[0][1] = 0.9990643876075032
pose30.orient[0][2] = -0.004159735434093078
pose30.orient[1][0] = 0.9990654363386795
pose30.orient[1][1] = 0.043030067964548224
pose30.orient[1][2] = -0.004082543860199306
pose30.orient[2][0] = -0.003899730483127227
pose30.orient[2][1] = -0.004331589247732161
pose30.orient[2][2] = -0.9999830145741216



poseup = pi.copy()
poseup.pos =  [-0.6041583869227467, 0.474270972035597, 0.17]
poseup.orient[0][0] = -0.04304702098360624
poseup.orient[0][1] = 0.9990643876075032
poseup.orient[0][2] = -0.004159735434093078
poseup.orient[1][0] = 0.9990654363386795
poseup.orient[1][1] = 0.043030067964548224
poseup.orient[1][2] = -0.004082543860199306
poseup.orient[2][0] = -0.003899730483127227
poseup.orient[2][1] = -0.004331589247732161
poseup.orient[2][2] = -0.9999830145741216




poses = [pose1,pose2,pose3,pose4,pose5,pose6,pose7,pose8,pose9,pose10,pose11,pose12,pose13,pose14,pose15,pose16,pose17,pose18,pose19,pose20,pose21,pose22,pose23,pose24,pose25,pose26,pose27]


def callback(data):
    global poses
    global rob
    global poseup
    # j0 = [0.1997201144695282, -2.0373409430133265, 2.512094020843506, -2.2755797545062464, -1.5713632742511194, -0.1660998503314417]
    # rob.movej(j0, 0.4, 2, wait=False)
    # rospy.sleep(4.5)
    j1 = [-0.11749,-1.087,1.8039,-2.2877,-1.5707,0.26535- 0.431271]
    rob.movej(j1, 0.75, 2.5, wait=False)
    rospy.sleep(3.0)
    rospy.loginfo('ur5 run starts ....')
    # try:
    #     rob.movexs("movep", poses, acc=0.2, vel=0.2, radius=0.005, wait=False)  # joint
    # except KeyboardInterrupt:
    #     print('Interrupted')
    # tsec = totimestamp(datetime.utcnow())
    # i = 0
    # j_target = [-0.42503,-1.0499,1.7316,-2.2526,-1.5709,-0.036474- 0.431271]
    # tolerance = 0.06
    # while totimestamp(datetime.utcnow()) - tsec < 3.25:
    #     i+=1
    #     if i % 100000 == 0:
    #         js = rob.getj()
    #         if (abs(js[0] - j_target[0]) < tolerance) and (abs(js[1] - j_target[1]) < tolerance) and (abs(js[2] - j_target[2]) < tolerance) and (abs(js[3] - j_target[3]) < tolerance) and (abs(js[4] - j_target[4]) < tolerance) and (abs(js[5] - j_target[5]) < tolerance):
    #             robotiq.go_to(int(float(0.69) * 255))
    # rob.movel(poseup, acc=0.2, vel=0.5, wait=False)
    # rospy.sleep(1.0)
    # j_end = [-1.6027973333941858, -1.4326069990741175, 2.1036601066589355, -3.7062509695636194, -1.5683444182025355, -0.1680229345904749]
    # rob.movej(j_end, 0.2, 1, wait=False)


def print_poseyawjoint(data):

    global rob

    print 'pose:',data.point.x,data.point.y,'\tyaw:',data.point.z,'\trobot_joint_angles:',rob.getj()
    
def ur5_to_base():
    rospy.init_node('demo_straight_arm', anonymous=True)
    rospy.Subscriber("ur5_run", Bool, callback)
    # rospy.Subscriber('base_pose',PointStamped,print_poseyawjoint)
    rospy.spin()

if __name__ == '__main__':
    ur5_to_base()